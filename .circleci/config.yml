version: 2.1

orbs:
  node: circleci/node@5
  browser-tools: circleci/browser-tools@1.2.3

jobs:
  lint:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run lint
          command: npm run lint

  unit-tests:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run unit tests with coverage
          command: |
            set +e
            npx c8 --reporter=json --reporter=text --lines 85 npm run test:unit
            TEST_EXIT=$?
            set -e

            if [ -f "coverage/coverage-final.json" ]; then
              mv coverage/coverage-final.json coverage/coverage-final-unit.json

              mkdir -p .nyc_output coverage/unit-artifacts
              cp coverage/coverage-final-unit.json .nyc_output/coverage.json
              npx nyc report --reporter=html --report-dir=coverage/unit-artifacts
              npx nyc report --reporter=text-summary > coverage/unit-artifacts/unit-text-summary.txt
              cp coverage/unit-artifacts/index.html coverage/unit-artifacts/indexUnit.html
            else
              mkdir -p coverage
              echo '{}' > coverage/coverage-final-unit.json
            fi

            exit $TEST_EXIT

      - store_artifacts:
          path: coverage/unit-artifacts
          destination: unit-test-coverage

      - persist_to_workspace:
          root: .
          paths:
            - coverage/coverage-final-unit.json

  e2e-tests:
    docker:
      - image: mcr.microsoft.com/playwright:v1.40.0-jammy
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm ci
      - run:
          name: Install Playwright browsers
          command: npx playwright install chromium
      - run:
          name: Run E2E tests with coverage
          command: |
            set +e
            npx c8 --reporter=json --reporter=text --lines 45 \
              npx playwright test --project='chromium'
            TEST_EXIT=$?
            set -e

            if [ -f "coverage/coverage-final.json" ]; then
              mv coverage/coverage-final.json coverage/coverage-final-e2e.json

              mkdir -p .nyc_output coverage/e2e-artifacts
              cp coverage/coverage-final-e2e.json .nyc_output/coverage.json
              npx nyc report --reporter=html --report-dir=coverage/e2e-artifacts
              npx nyc report --reporter=text-summary > coverage/e2e-artifacts/e2e-text-summary.txt
              cp coverage/e2e-artifacts/index.html coverage/e2e-artifacts/indexE2e.html
            else
              mkdir -p coverage
              echo '{}' > coverage/coverage-final-e2e.json
            fi

            exit $TEST_EXIT

      - store_artifacts:
          path: test/e2e/reports
          destination: test-results
      - store_artifacts:
          path: videos
          destination: videos
      - store_artifacts:
          path: test-results
          destination: screenshots

      - persist_to_workspace:
          root: .
          paths:
            - coverage/coverage-final-e2e.json

  check-coverage:
    executor: node/default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - attach_workspace:
          at: .
      - run:
          name: Merge and generate final coverage
          command: |
            mkdir -p coverage .nyc_output coverage/normalized

            UNIT_FILE="coverage/coverage-final-unit.json"
            E2E_FILE="coverage/coverage-final-e2e.json"

            if [ -f "$UNIT_FILE" ]; then
              sed 's|"/home/circleci/project/|"/project/|g' "$UNIT_FILE" > coverage/normalized/unit.json
            fi

            if [ -f "$E2E_FILE" ]; then
              sed 's|"/root/project/|"/project/|g' "$E2E_FILE" > coverage/normalized/e2e.json
            fi

            npx nyc merge coverage/normalized .nyc_output/coverage.json

            sed 's|"/project/|"/home/circleci/project/|g' .nyc_output/coverage.json > .nyc_output/coverage-final.json
            mv .nyc_output/coverage-final.json .nyc_output/coverage.json

            mkdir -p coverage/combined-artifacts
            npx nyc report --reporter=html --report-dir=coverage/combined-artifacts
            npx nyc report --reporter=text-summary > coverage/combined-artifacts/combined-text-summary.txt
            cp coverage/combined-artifacts/index.html coverage/combined-artifacts/indexCombined.html

            npx nyc report --reporter=lcov --report-dir=coverage/combined-artifacts
            npx nyc report --check-coverage --lines=90 --functions=85 --branches=90

      - store_artifacts:
          path: coverage/combined-artifacts
          destination: combined-coverage-reports

      - store_artifacts:
          path: coverage
          destination: all-coverage-files

workflows:
  lint:
    jobs:
      - lint

  build-and-test:
    jobs:
      - unit-tests
      - e2e-tests
      - check-coverage:
          requires:
            - unit-tests
            - e2e-tests
